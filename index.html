<script>
(async () => {
  const data = {
    ip: 'unknown',
    userAgent: navigator.userAgent,
    language: navigator.language,
    screenSize: `${screen.width}x${screen.height}`,
    url: location.href,
    platform: navigator.platform,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
    localTime: new Date().toString(),
    deviceType: /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent) ? "Mobile" : "Desktop",
  };

  // Try to get IP from public API
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const json = await res.json();
    data.ip = json.ip || data.ip;
  } catch {}

  // Try to get geolocation
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        data.latitude = pos.coords.latitude;
        data.longitude = pos.coords.longitude;
        await sendData();
      },
      async () => {
        await sendData();
      },
      { timeout: 10000 }
    );
  } else {
    await sendData();
  }

  async function sendData() {
    try {
      await fetch("/api/log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
    } catch (e) {
      console.error("Failed to send visitor data", e);
    }
  }
})();
</script>
